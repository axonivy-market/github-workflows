name: Translation Locker

on:
  workflow_call:

jobs:
  prevent-modification:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR author
        id: check_author
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "PR author: $PR_AUTHOR"

          if [ "$PR_AUTHOR" = "weblate" ]; then
            echo "✓ Author is weblate, bypassing README_DE.md check"
            echo "bypass=true" >> $GITHUB_OUTPUT
          else
            echo "Author is not weblate, will check README_DE.md modifications"
            echo "bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if README_DE.md existed on default branch
        if: steps.check_author.outputs.bypass != 'true'
        run: |
          git fetch origin ${{ github.base_ref }}
          if git ls-tree -r origin/${{ github.base_ref }} --name-only | grep -q 'README_DE\.md$'; then
            echo "README_DE.md exists, checking for modification"
            if ! git diff --exit-code origin/${{ github.base_ref }}...HEAD -- '**/README_DE.md'; then
              echo "⚠ ERROR: Modification of README_DE.md is not allowed."
              exit 1
            fi
          else
            echo "✓ README_DE.md does not exist on default branch, file can be created."
          fi
